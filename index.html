// ========== –°–ò–°–¢–ï–ú–ê –ë–ê–§–û–í ==========
const BUFFS = {
    BIG_BALL: {
        id: 'big_ball',
        name: 'üî• –ë–æ–ª—å—à–æ–π –º—è—á',
        duration: 240, // 4 —Å–µ–∫—É–Ω–¥—ã (60 FPS * 4)
        effect: 'size',
        multiplier: 2.0,
        color: '#FF9800',
        icon: 'üî•'
    },
    SPEED_BOOST: {
        id: 'speed_boost',
        name: '‚ö° –£—Å–∫–æ—Ä–µ–Ω–∏–µ',
        duration: 180, // 3 —Å–µ–∫—É–Ω–¥—ã
        effect: 'speed',
        multiplier: 1.5,
        color: '#2196F3',
        icon: '‚ö°'
    },
    COLOR_CHANGE: {
        id: 'color_change',
        name: 'üåà –¶–≤–µ—Ç–Ω–æ–π –º—è—á',
        duration: 300, // 5 —Å–µ–∫—É–Ω–¥
        effect: 'color',
        colors: ['#FF5252', '#4CAF50', '#2196F3', '#FFEB3B', '#E91E63'],
        icon: 'üåà',
        bonusPoints: 1
    }
};

// –í –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–∏—Å—Ç–µ–º—ã –±–∞—Ñ–æ–≤ –∏–∑–º–µ–Ω–∏—Ç–µ buffSystem:
let buffSystem = {
    cooldown: 1800, // 30 —Å–µ–∫—É–Ω–¥ (60 FPS * 30)
    activeBuff: null,
    activeUntil: 0,
    buffIcon: { 
        x: 0, 
        y: 0, // –ò–ó–ú–ï–ù–ò–õ–û–°–¨: —Ç–µ–ø–µ—Ä—å –Ω–µ -50, –∞ 0
        type: null, 
        visible: false, 
        speed: 0, // –ò–ó–ú–ï–ù–ò–õ–û–°–¨: —Å–∫–æ—Ä–æ—Å—Ç—å 0
        collected: false,
        rotation: 0,
        pulse: 0
    },
    hitsWithColor: 0,
    originalBallSize: 10,
    originalBallSpeed: 5
};

// –í —Ñ—É–Ω–∫—Ü–∏–∏ spawnBuffIcon –∏–∑–º–µ–Ω–∏—Ç–µ:
function spawnBuffIcon() {
    if (buffSystem.activeBuff || buffSystem.buffIcon.visible) return;
    
    const buffTypes = Object.values(BUFFS);
    const randomBuff = buffTypes[Math.floor(Math.random() * buffTypes.length)];
    
    // –°–ª—É—á–∞–π–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è –≤ –≤–µ—Ä—Ö–Ω–µ–π —á–∞—Å—Ç–∏ –ø–æ–ª—è
    buffSystem.buffIcon = {
        x: 100 + Math.random() * (canvas.width - 200), // –ù–µ —Å–ª–∏—à–∫–æ–º –±–ª–∏–∑–∫–æ –∫ –∫—Ä–∞—è–º
        y: 80 + Math.random() * 100, // –í–µ—Ä—Ö–Ω—è—è —á–∞—Å—Ç—å –ø–æ–ª—è
        type: randomBuff,
        visible: true,
        speed: 0, // –°—Ç–∞—Ç–∏—á–Ω—ã–π
        collected: false,
        rotation: 0,
        pulse: 0
    };
}

// –í —Ñ—É–Ω–∫—Ü–∏–∏ updateBuffs –∏–∑–º–µ–Ω–∏—Ç–µ —á–∞—Å—Ç—å –¥–≤–∏–∂–µ–Ω–∏—è:
function updateBuffs() {
    if (!game.buffsEnabled || !game.active) return;
    
    // –¢–∞–π–º–µ—Ä –ø–µ—Ä–µ–∑–∞—Ä—è–¥–∫–∏
    if (buffSystem.cooldown > 0 && !buffSystem.buffIcon.visible) {
        buffSystem.cooldown--;
        
        // –ü–æ—è–≤–ª–µ–Ω–∏–µ –∏–∫–æ–Ω–∫–∏ –±–∞—Ñ–∞
        if (buffSystem.cooldown <= 0) {
            spawnBuffIcon();
            buffSystem.cooldown = 1800; // 30 —Å–µ–∫—É–Ω–¥
        }
    }
    
    // –ê–ù–ò–ú–ê–¶–ò–Ø –ë–ê–§–ê (–ø—É–ª—å—Å–∞—Ü–∏—è –∏ –≤—Ä–∞—â–µ–Ω–∏–µ –≤–º–µ—Å—Ç–æ –ø–∞–¥–µ–Ω–∏—è)
    if (buffSystem.buffIcon.visible) {
        const icon = buffSystem.buffIcon;
        
        // –í—Ä–∞—â–µ–Ω–∏–µ
        icon.rotation += 0.02;
        if (icon.rotation > Math.PI * 2) {
            icon.rotation = 0;
        }
        
        // –ü—É–ª—å—Å–∞—Ü–∏—è
        icon.pulse = Math.sin(Date.now() / 500) * 0.2 + 1; // –û—Ç 0.8 –¥–æ 1.2
        
        // –ë–∞—Ñ –Ω–µ –ø–∞–¥–∞–µ—Ç, –æ—Å—Ç–∞–µ—Ç—Å—è –Ω–∞ –º–µ—Å—Ç–µ
        // icon.y += icon.speed; // –£–ë–†–ê–ù–û
        
        // –ò—Å—á–µ–∑–∞–µ—Ç —á–µ—Ä–µ–∑ 10 —Å–µ–∫—É–Ω–¥ –µ—Å–ª–∏ –Ω–µ —Å–æ–±—Ä–∞–Ω
        if (buffSystem.buffIcon.duration) {
            buffSystem.buffIcon.duration--;
            if (buffSystem.buffIcon.duration <= 0) {
                buffSystem.buffIcon.visible = false;
            }
        }
    }
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏—è —Å —Ä–∞–∫–µ—Ç–∫–æ–π
    if (buffSystem.buffIcon.visible) {
        const icon = buffSystem.buffIcon;
        // –£–≤–µ–ª–∏—á–µ–Ω–Ω–∞—è –∑–æ–Ω–∞ —Å–±–æ—Ä–∞ –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞
        const collectRadius = 35;
        const paddleCenterX = player.x + player.width / 2;
        const paddleCenterY = player.y + player.height / 2;
        
        // –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –æ—Ç —Ü–µ–Ω—Ç—Ä–∞ –±–∞—Ñ–∞ –¥–æ —Ü–µ–Ω—Ç—Ä–∞ —Ä–∞–∫–µ—Ç–∫–∏
        const distance = Math.sqrt(
            Math.pow(icon.x - paddleCenterX, 2) + 
            Math.pow(icon.y - paddleCenterY, 2)
        );
        
        if (distance < collectRadius) {
            activateBuff(icon.type);
            buffSystem.buffIcon.visible = false;
            if (game.sound) beep(1200, 0.3);
        }
    }
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –±–∞—Ñ–∞
    if (buffSystem.activeBuff) {
        buffSystem.activeUntil--;
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞
        const secondsLeft = Math.ceil(buffSystem.activeUntil / 60);
        document.getElementById('activeBuffInfo').textContent = 
            `${buffSystem.activeBuff.icon} ${buffSystem.activeBuff.name}: ${secondsLeft}—Å`;
        
        if (buffSystem.activeUntil <= 0) {
            deactivateBuff();
        }
    }
}

// –í —Ñ—É–Ω–∫—Ü–∏–∏ drawBuffs –∏–∑–º–µ–Ω–∏—Ç–µ –æ—Ç—Ä–∏—Å–æ–≤–∫—É:
function drawBuffs() {
    // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∏–∫–æ–Ω–∫–∏ –±–∞—Ñ–∞
    if (buffSystem.buffIcon.visible) {
        const icon = buffSystem.buffIcon;
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
        ctx.save();
        
        // –ü–µ—Ä–µ–º–µ—â–∞–µ–º –∏ –≤—Ä–∞—â–∞–µ–º –≤–æ–∫—Ä—É–≥ —Ü–µ–Ω—Ç—Ä–∞ –±–∞—Ñ–∞
        ctx.translate(icon.x, icon.y);
        ctx.rotate(icon.rotation);
        
        // –ü—É–ª—å—Å–∞—Ü–∏—è
        const scale = icon.pulse;
        ctx.scale(scale, scale);
        
        // –°–≤–µ—á–µ–Ω–∏–µ
        ctx.shadowColor = icon.type.color;
        ctx.shadowBlur = 20 * scale;
        
        // –í–Ω–µ—à–Ω–∏–π –∫—Ä—É–≥ (—Å–≤–µ—á–µ–Ω–∏–µ)
        ctx.fillStyle = icon.type.color + '80'; // –ü–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π
        ctx.beginPath();
        ctx.arc(0, 0, 25, 0, Math.PI * 2);
        ctx.fill();
        
        // –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –∫—Ä—É–≥
        ctx.fillStyle = icon.type.color;
        ctx.beginPath();
        ctx.arc(0, 0, 20, 0, Math.PI * 2);
        ctx.fill();
        
        // –ò–∫–æ–Ω–∫–∞
        ctx.fillStyle = '#FFFFFF';
        ctx.font = 'bold 20px Arial';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(icon.type.icon, 0, 0);
        
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç
        ctx.restore();
        
        // –°–±—Ä–æ—Å —Ç–µ–Ω–∏
        ctx.shadowBlur = 0;
        
        // –ü–æ–¥—Å–∫–∞–∑–∫–∞ (–ø—É–ª—å—Å–∏—Ä—É—é—â–∏–π —Ç–µ–∫—Å—Ç)
        ctx.fillStyle = '#FF9800';
        ctx.font = '12px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('–°–æ–±–µ—Ä–∏ –±–∞—Ñ!', icon.x, icon.y + 40);
    }
    
    // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —ç—Ñ—Ñ–µ–∫—Ç–æ–≤ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –±–∞—Ñ–∞
    if (buffSystem.activeBuff) {
        const buff = buffSystem.activeBuff;
        
        // –≠—Ñ—Ñ–µ–∫—Ç –¥–ª—è —Ü–≤–µ—Ç–Ω–æ–≥–æ –º—è—á–∞
        if (buff.effect === 'color') {
            const colorIndex = buffSystem.hitsWithColor % buff.colors.length;
            ctx.fillStyle = buff.colors[colorIndex];
        }
    }
}

// –¢–∞–∫–∂–µ –¥–æ–±–∞–≤—å—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é beep (–µ—Å–ª–∏ –µ—ë –Ω–µ—Ç):
function beep(freq, duration) {
    if (!game.sound) return;
    
    try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.value = freq;
        oscillator.type = 'sine';
        
        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
        
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + duration);
    } catch (e) {
        console.log("Audio not supported");
    }
}

// –í initGame –æ–±–Ω–æ–≤–∏—Ç–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é buffSystem:
function initGame() {
    // ... –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∫–æ–¥ ...
    
    // –°–±—Ä–æ—Å —Å–∏—Å—Ç–µ–º—ã –±–∞—Ñ–æ–≤
    buffSystem = {
        cooldown: 1800,
        activeBuff: null,
        activeUntil: 0,
        buffIcon: { 
            x: 0, 
            y: 0, 
            type: null, 
            visible: false, 
            speed: 0,
            collected: false,
            rotation: 0,
            pulse: 0
        },
        hitsWithColor: 0,
        originalBallSize: ball.size,
        originalBallSpeed: game.ballSpeed
    };
    
    // ... –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ ...
}
