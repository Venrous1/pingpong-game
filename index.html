<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ping Pong Pro</title>
    <style>
        /* –°–ë–†–û–° –°–¢–ò–õ–ï–ô */
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }
        
        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: #000;
            font-family: Arial, sans-serif;
            color: white;
        }
        
        /* –ö–û–ù–¢–ï–ô–ù–ï–† */
        .game-container {
            width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 10px;
        }
        
        /* –ó–ê–ì–û–õ–û–í–û–ö (—Ç–æ–ª—å–∫–æ –≤ –º–µ–Ω—é) */
        .game-title {
            text-align: center;
            padding: 10px 0;
            color: #4CAF50;
            font-size: 28px;
            text-shadow: 0 0 10px #4CAF50;
            margin-bottom: 10px;
        }
        
        .version {
            color: #888;
            font-size: 12px;
            text-align: center;
            margin-bottom: 20px;
        }
        
        /* –û–ë–©–ò–ï –≠–ö–†–ê–ù–´ */
        .screen {
            display: none;
            flex: 1;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 15px;
            width: 100%;
        }
        
        #menuScreen { display: flex; }
        
        /* –ö–ù–û–ü–ö–ò –ú–ï–ù–Æ */
        .menu-buttons {
            width: 100%;
            max-width: 300px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 20px;
        }
        
        .menu-btn {
            padding: 16px;
            font-size: 18px;
            background: #2E7D32;
            color: white;
            border: 2px solid #4CAF50;
            border-radius: 12px;
            cursor: pointer;
            text-align: center;
            width: 100%;
            transition: transform 0.1s;
        }
        
        .menu-btn:active {
            transform: scale(0.97);
            background: #388E3C;
        }
        
        /* –ò–ù–§–û –¢–ï–ö–°–¢ */
        .menu-info {
            margin-top: 30px;
            color: #aaa;
            font-size: 14px;
            text-align: center;
            line-height: 1.4;
            padding: 0 10px;
        }
        
        /* –ò–ì–†–û–í–û–ï –ü–û–õ–ï */
        #gameScreen {
            justify-content: flex-start;
            padding: 5px;
        }
        
        .game-header {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding: 0 5px;
        }
        
        .score {
            font-size: 24px;
            font-weight: bold;
            color: #FFEB3B;
            min-width: 80px;
        }
        
        .buff-timer {
            font-size: 12px;
            color: #FF9800;
            margin-left: 5px;
        }
        
        .difficulty-badge {
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
            background: #333;
        }
        
        .easy-badge { background: #4CAF50; }
        .hard-badge { background: #FF9800; }
        .ultra-badge { background: #f44336; }
        
        /* CANVAS */
        #gameCanvas {
            background: #000;
            border: 2px solid white;
            border-radius: 5px;
            display: block;
            width: 100%;
            height: 50vh;
            max-height: 400px;
        }
        
        /* –£–ü–†–ê–í–õ–ï–ù–ò–ï –í –ò–ì–†–ï */
        .game-controls {
            width: 100%;
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
            padding: 0 10px;
        }
        
        .control-btn {
            padding: 12px 20px;
            font-size: 16px;
            background: #333;
            color: white;
            border: 2px solid #666;
            border-radius: 10px;
            cursor: pointer;
            flex: 1;
            max-width: 150px;
            text-align: center;
        }
        
        .control-btn:active {
            background: #444;
        }
        
        /* –ú–û–ë–ò–õ–¨–ù–´–ï –ö–ù–û–ü–ö–ò –£–ü–†–ê–í–õ–ï–ù–ò–Ø */
        .mobile-game-controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
            width: 100%;
            padding: 0 20px;
        }
        
        .mobile-btn {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: linear-gradient(145deg, #444, #222);
            border: 3px solid white;
            color: white;
            font-size: 24px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            user-select: none;
        }
        
        .mobile-btn:active {
            transform: scale(0.9);
            background: linear-gradient(145deg, #555, #333);
        }
        
        /* –≠–ö–†–ê–ù –ö–û–ù–¶–ê –ò–ì–†–´ */
        #gameOverScreen { 
            text-align: center; 
            justify-content: center; 
        }
        
        .game-over-title {
            font-size: 28px;
            color: #f44336;
            margin-bottom: 15px;
        }
        
        .game-message {
            font-size: 18px;
            color: #FF9800;
            margin: 15px 0;
            padding: 0 10px;
        }
        
        .final-score {
            font-size: 32px;
            color: #4CAF50;
            font-weight: bold;
            margin: 20px 0;
        }
        
        /* –ù–ê–°–¢–†–û–ô–ö–ò */
        .settings-group {
            width: 100%;
            max-width: 300px;
            background: #111;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
        }
        
        .setting-item {
            margin: 15px 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .setting-label {
            font-size: 16px;
            color: #ccc;
        }
        
        input[type="range"] {
            width: 100%;
            margin: 10px 0;
        }
        
        /* –ò–ù–î–ò–ö–ê–¢–û–† –ë–ê–§–û–í */
        .buffs-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.7);
            padding: 8px 12px;
            border-radius: 10px;
            border: 2px solid #FF9800;
            font-size: 14px;
            display: none;
        }
        
        .buff-active {
            color: #FF9800;
            font-weight: bold;
        }
        
        /* –ê–î–ê–ü–¢–ò–í–ù–û–°–¢–¨ */
        @media (max-width: 480px) {
            .game-title { font-size: 24px; }
            .menu-btn { padding: 14px; font-size: 16px; }
            .score { font-size: 20px; }
            .control-btn { padding: 10px; font-size: 14px; }
            .mobile-btn { width: 60px; height: 60px; font-size: 20px; }
            .game-over-title { font-size: 24px; }
            .game-message { font-size: 16px; }
            .final-score { font-size: 28px; }
            .buffs-indicator { top: 5px; right: 5px; padding: 5px 8px; font-size: 12px; }
        }
        
        @media (max-height: 700px) {
            #gameCanvas { height: 45vh; }
            .game-header { margin-bottom: 5px; }
            .game-controls { margin-top: 10px; }
            .mobile-game-controls { margin-top: 10px; }
        }
        
        /* –£–¢–ò–õ–ò–¢–´ */
        .back-btn {
            background: #555 !important;
            border-color: #777 !important;
            margin-top: 20px;
        }
        
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div class="game-container">
        <!-- –ì–õ–ê–í–ù–û–ï –ú–ï–ù–Æ -->
        <div id="menuScreen" class="screen">
            <h1 class="game-title">PING PONG PRO</h1>
            <div class="version">–í–µ—Ä—Å–∏—è 1.2 —Å –±–∞—Ñ–∞–º–∏</div>
            
            <div class="menu-buttons">
                <button class="menu-btn" onclick="startGame()">‚ñ∂ –ù–ê–ß–ê–¢–¨ –ò–ì–†–£</button>
                <button class="menu-btn" onclick="showScreen('difficultyScreen')">‚öô –°–õ–û–ñ–ù–û–°–¢–¨</button>
                <button class="menu-btn" onclick="showScreen('settingsScreen')">üîß –ù–ê–°–¢–†–û–ô–ö–ò</button>
            </div>
            
            <div class="menu-info">
                <p>üéÆ <strong>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:</strong></p>
                <p>–ö–æ–º–ø—å—é—Ç–µ—Ä: W/S –∏–ª–∏ —Å—Ç—Ä–µ–ª–∫–∏</p>
                <p>–¢–µ–ª–µ—Ñ–æ–Ω: –∫–Ω–æ–ø–∫–∏ ‚Üì</p>
                <p>–ü–∞—É–∑–∞: –ü—Ä–æ–±–µ–ª –∏–ª–∏ –∫–Ω–æ–ø–∫–∞ ‚è∏</p>
                <p style="color:#FF9800; margin-top:10px;">üî• –ù–æ–≤–æ–µ: –°–∏—Å—Ç–µ–º–∞ –±–∞—Ñ–æ–≤!</p>
            </div>
        </div>
        
        <!-- –í–´–ë–û–† –°–õ–û–ñ–ù–û–°–¢–ò -->
        <div id="difficultyScreen" class="screen">
            <h2 style="color:#4CAF50; margin-bottom:25px;">üéØ –°–õ–û–ñ–ù–û–°–¢–¨</h2>
            
            <div class="menu-buttons">
                <button class="menu-btn" onclick="setDifficulty('easy')">üü¢ –õ–ï–ì–ö–ê–Ø</button>
                <button class="menu-btn" onclick="setDifficulty('hard')">üü° –°–õ–û–ñ–ù–ê–Ø</button>
                <button class="menu-btn" onclick="setDifficulty('ultra')">üî¥ –£–õ–¨–¢–†–ê</button>
                <button class="menu-btn back-btn" onclick="backToMenu()">‚Üê –ù–ê–ó–ê–î</button>
            </div>
        </div>
        
        <!-- –ù–ê–°–¢–†–û–ô–ö–ò -->
        <div id="settingsScreen" class="screen">
            <h2 style="color:#FF9800; margin-bottom:25px;">üîß –ù–ê–°–¢–†–û–ô–ö–ò</h2>
            
            <div class="settings-group">
                <div class="setting-item">
                    <span class="setting-label">üîä –ó–≤—É–∫–∏</span>
                    <input type="checkbox" id="soundToggle" checked>
                </div>
                
                <div class="setting-item">
                    <span class="setting-label">üì± –ö–Ω–æ–ø–∫–∏ –Ω–∞ —ç–∫—Ä–∞–Ω–µ</span>
                    <input type="checkbox" id="mobileButtons" checked>
                </div>
                
                <div class="setting-item">
                    <span class="setting-label">üéÆ –°–∏—Å—Ç–µ–º–∞ –±–∞—Ñ–æ–≤</span>
                    <input type="checkbox" id="buffsToggle" checked>
                </div>
                
                <div class="setting-item" style="flex-direction:column; align-items:stretch;">
                    <span class="setting-label">‚ö° –°–∫–æ—Ä–æ—Å—Ç—å: <span id="speedValue">5</span></span>
                    <input type="range" id="ballSpeed" min="3" max="8" value="5">
                </div>
            </div>
            
            <div class="menu-buttons">
                <button class="menu-btn" onclick="saveSettings()">üíæ –°–û–•–†–ê–ù–ò–¢–¨</button>
                <button class="menu-btn back-btn" onclick="backToMenu()">‚Üê –ù–ê–ó–ê–î</button>
            </div>
        </div>
        
        <!-- –ö–û–ù–ï–¶ –ò–ì–†–´ -->
        <div id="gameOverScreen" class="screen">
            <h2 class="game-over-title" id="gameOverTitle">–ò–ì–†–ê –û–ö–û–ù–ß–ï–ù–ê</h2>
            <div class="game-message" id="gameMessage"></div>
            <div class="final-score" id="finalScore">0 : 0</div>
            
            <div class="menu-buttons">
                <button class="menu-btn" onclick="restartGame()">üîÑ –ò–ì–†–ê–¢–¨ –°–ù–û–í–ê</button>
                <button class="menu-btn" onclick="backToMenu()">üè† –í –ú–ï–ù–Æ</button>
            </div>
        </div>
        
        <!-- –ò–ì–†–ê -->
        <div id="gameScreen" class="screen">
            <div class="game-header">
                <div class="score" id="scoreDisplay">0 : 0</div>
                <div class="difficulty-badge easy-badge" id="difficultyBadge">–õ–ï–ì–ö–ê–Ø</div>
            </div>
            
            <canvas id="gameCanvas"></canvas>
            
            <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –±–∞—Ñ–æ–≤ -->
            <div class="buffs-indicator" id="buffsIndicator">
                <span id="buffStatus">–ë–∞—Ñ—ã: üü¢ –í–∫–ª</span>
                <div id="activeBuffInfo" class="buff-active" style="display:none; margin-top:5px;"></div>
            </div>
            
            <div class="game-controls">
                <button class="control-btn" onclick="pauseGame()" id="pauseBtn">‚è∏ –ü–ê–£–ó–ê</button>
                <button class="control-btn" onclick="backToMenu()">üè† –ú–ï–ù–Æ</button>
            </div>
            
            <div class="mobile-game-controls" id="mobileControls">
                <button class="mobile-btn" id="upBtn">‚Üë</button>
                <button class="mobile-btn" onclick="pauseGame()">‚è∏</button>
                <button class="mobile-btn" id="downBtn">‚Üì</button>
            </div>
        </div>
    </div>

    <script>
        // ========== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ==========
        const DIFFICULTY = {
            easy: { ballSpeed: 4, aiSpeed: 3, aiAccuracy: 0.7 },
            hard: { ballSpeed: 6, aiSpeed: 4, aiAccuracy: 0.85 },
            ultra: { ballSpeed: 8, aiSpeed: 5, aiAccuracy: 0.95 }
        };
        
        const PHRASES = {
            win: [
                "–ü–æ–±–µ–¥–∞! üèÜ", "–û—Ç–ª–∏—á–Ω–æ! üéØ", "AI –ø–æ–≤–µ—Ä–∂–µ–Ω! ü§ñ", 
                "–ú–∞—Å—Ç–µ—Ä –ø–∏–Ω–≥-–ø–æ–Ω–≥–∞! üëë", "–ë—Ä–∞–≤–æ! ‚ú®", "–ù–µ–≤–µ—Ä–æ—è—Ç–Ω–æ! üöÄ"
            ],
            lose: [
                "–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞", "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë! üîÑ", "AI —Å–∏–ª—å–Ω–µ–µ...", 
                "–ü–æ—á—Ç–∏ –ø–æ–ª—É—á–∏–ª–æ—Å—å! ‚ö°", "–¢—Ä–µ–Ω–∏—Ä—É–π—Ç–µ—Å—å! üèì", "–í —Å–ª–µ–¥—É—é—â–∏–π —Ä–∞–∑! üí™"
            ]
        };
        
        // ========== –°–ò–°–¢–ï–ú–ê –ë–ê–§–û–í ==========
        const BUFFS = {
            BIG_BALL: {
                id: 'big_ball',
                name: 'üî• –ë–æ–ª—å—à–æ–π –º—è—á',
                duration: 240, // 4 —Å–µ–∫—É–Ω–¥—ã (60 FPS * 4)
                effect: 'size',
                multiplier: 2.0,
                color: '#FF9800',
                icon: 'üî•'
            },
            SPEED_BOOST: {
                id: 'speed_boost',
                name: '‚ö° –£—Å–∫–æ—Ä–µ–Ω–∏–µ',
                duration: 180, // 3 —Å–µ–∫—É–Ω–¥—ã
                effect: 'speed',
                multiplier: 1.5,
                color: '#2196F3',
                icon: '‚ö°'
            },
            COLOR_CHANGE: {
                id: 'color_change',
                name: 'üåà –¶–≤–µ—Ç–Ω–æ–π –º—è—á',
                duration: 300, // 5 —Å–µ–∫—É–Ω–¥
                effect: 'color',
                colors: ['#FF5252', '#4CAF50', '#2196F3', '#FFEB3B', '#E91E63'],
                icon: 'üåà',
                bonusPoints: 1
            }
        };
        
        // ========== –°–û–°–¢–û–Ø–ù–ò–ï –ò–ì–†–´ ==========
        let canvas, ctx;
        let game = {
            active: false,
            paused: false,
            difficulty: 'easy',
            playerScore: 0,
            opponentScore: 0,
            sound: true,
            showMobile: true,
            ballSpeed: 5,
            buffsEnabled: true
        };
        
        // –ò–≥—Ä–æ–≤—ã–µ –æ–±—ä–µ–∫—Ç—ã
        let player, opponent, ball;
        let keys = {};
        
        // –°–∏—Å—Ç–µ–º–∞ –±–∞—Ñ–æ–≤
        let buffSystem = {
            cooldown: 900, // 30 —Å–µ–∫—É–Ω–¥ (60 FPS * 30)
            activeBuff: null,
            activeUntil: 0,
            buffIcon: { x: 0, y: -50, type: null, visible: false, speed: 2 },
            hitsWithColor: 0,
            originalBallSize: 10,
            originalBallSpeed: 5
        };
        
        // ========== –£–ü–†–ê–í–õ–ï–ù–ò–ï –≠–ö–†–ê–ù–ê–ú–ò ==========
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.style.display = 'none');
            const screen = document.getElementById(screenId);
            if (screen) {
                screen.style.display = 'flex';
            }
        }
        
        function backToMenu() {
            game.active = false;
            showScreen('menuScreen');
        }
        
        function setDifficulty(diff) {
            game.difficulty = diff;
            const names = { easy: '–õ–ï–ì–ö–ê–Ø', hard: '–°–õ–û–ñ–ù–ê–Ø', ultra: '–£–õ–¨–¢–†–ê' };
            const colors = { easy: 'easy-badge', hard: 'hard-badge', ultra: 'ultra-badge' };
            
            document.getElementById('difficultyBadge').textContent = names[diff];
            document.getElementById('difficultyBadge').className = `difficulty-badge ${colors[diff]}`;
            
            backToMenu();
        }
        
        function saveSettings() {
            game.sound = document.getElementById('soundToggle').checked;
            game.showMobile = document.getElementById('mobileButtons').checked;
            game.buffsEnabled = document.getElementById('buffsToggle').checked;
            game.ballSpeed = parseInt(document.getElementById('ballSpeed').value);
            document.getElementById('speedValue').textContent = game.ballSpeed;
            
            document.getElementById('mobileControls').classList.toggle('hidden', !game.showMobile);
            localStorage.setItem('pingpongSettings', JSON.stringify(game));
            
            backToMenu();
        }
        
        // ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ò–ì–†–´ ==========
        function startGame() {
            showScreen('gameScreen');
            initGame();
        }
        
        function initGame() {
            // Canvas
            canvas = document.getElementById('gameCanvas');
            ctx = canvas.getContext('2d');
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞–∑–º–µ—Ä
            const container = canvas.parentElement;
            const maxWidth = Math.min(500, container.clientWidth - 20);
            canvas.width = maxWidth;
            canvas.height = Math.min(400, window.innerHeight * 0.5);
            
            // –û–±—ä–µ–∫—Ç—ã
            player = {
                x: 15,
                y: canvas.height / 2 - 50,
                width: 10,
                height: 100,
                speed: 6
            };
            
            opponent = {
                x: canvas.width - 25,
                y: canvas.height / 2 - 50,
                width: 10,
                height: 100,
                speed: DIFFICULTY[game.difficulty].aiSpeed
            };
            
            ball = {
                x: canvas.width / 2,
                y: canvas.height / 2,
                size: 10,
                dx: game.ballSpeed * (Math.random() > 0.5 ? 1 : -1),
                dy: game.ballSpeed * (Math.random() > 0.5 ? 1 : -1),
                originalColor: '#FFFFFF'
            };
            
            // –°–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è
            game.playerScore = 0;
            game.opponentScore = 0;
            game.active = true;
            game.paused = false;
            
            // –°–±—Ä–æ—Å —Å–∏—Å—Ç–µ–º—ã –±–∞—Ñ–æ–≤
            buffSystem = {
                cooldown: 900,
                activeBuff: null,
                activeUntil: 0,
                buffIcon: { x: 0, y: -50, type: null, visible: false, speed: 2 },
                hitsWithColor: 0,
                originalBallSize: ball.size,
                originalBallSpeed: game.ballSpeed
            };
            
            // –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –±–∞—Ñ–æ–≤
            document.getElementById('buffsIndicator').style.display = 'block';
            document.getElementById('buffStatus').textContent = 
                game.buffsEnabled ? '–ë–∞—Ñ—ã: üü¢ –í–∫–ª' : '–ë–∞—Ñ—ã: üî¥ –í—ã–∫–ª';
            document.getElementById('activeBuffInfo').style.display = 'none';
            
            updateScore();
            setupControls();
            document.getElementById('mobileControls').classList.toggle('hidden', !game.showMobile);
            document.getElementById('pauseBtn').textContent = '‚è∏ –ü–ê–£–ó–ê';
            
            gameLoop();
        }
        
        // ========== –£–ü–†–ê–í–õ–ï–ù–ò–ï ==========
        function setupControls() {
            keys = {};
            
            // –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞
            document.onkeydown = (e) => {
                const key = e.key.toLowerCase();
                if (['w', 's', 'arrowup', 'arrowdown', ' ', 'p'].includes(key)) {
                    keys[key] = true;
                    if ((key === ' ' || key === 'p') && game.active) {
                        pauseGame();
                        e.preventDefault();
                    }
                }
            };
            
            document.onkeyup = (e) => {
                const key = e.key.toLowerCase();
                if (['w', 's', 'arrowup', 'arrowdown'].includes(key)) {
                    keys[key] = false;
                }
            };
            
            // –ú–æ–±–∏–ª—å–Ω—ã–µ –∫–Ω–æ–ø–∫–∏
            ['upBtn', 'downBtn'].forEach(id => {
                const btn = document.getElementById(id);
                const clear = () => keys['arrowup'] = keys['arrowdown'] = false;
                
                btn.ontouchstart = btn.onmousedown = () => {
                    keys[id === 'upBtn' ? 'arrowup' : 'arrowdown'] = true;
                };
                
                btn.ontouchend = btn.onmouseup = btn.onmouseleave = clear;
            });
        }
        
        // ========== –°–ò–°–¢–ï–ú–ê –ë–ê–§–û–í ==========
        function updateBuffs() {
            if (!game.buffsEnabled || !game.active) return;
    
    // –¢–∞–π–º–µ—Ä –ø–µ—Ä–µ–∑–∞—Ä—è–¥–∫–∏
    if (buffSystem.cooldown > 0 && !buffSystem.buffIcon.visible) {
        buffSystem.cooldown--;
        
        // –ü–æ—è–≤–ª–µ–Ω–∏–µ –∏–∫–æ–Ω–∫–∏ –±–∞—Ñ–∞
        if (buffSystem.cooldown <= 0) {
            spawnBuffIcon();
            buffSystem.cooldown = 900; // 15 —Å–µ–∫—É–Ω–¥ ‚Üê –ò–ó–ú–ï–ù–ò–õ–û–°–¨!
        }
    }
    
      // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—á–Ω–æ–≥–æ –±–∞—Ñ–∞
    if (buffSystem.buffIcon.visible) {
        buffSystem.buffIcon.timeLeft--;
        
        // –ú–µ—Ä—Ü–∞–Ω–∏–µ –ø–µ—Ä–µ–¥ –∏—Å—á–µ–∑–Ω–æ–≤–µ–Ω–∏–µ–º (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 120 –∫–∞–¥—Ä–æ–≤ = 2 —Å–µ–∫—É–Ω–¥—ã)
        if (buffSystem.buffIcon.timeLeft < 120) {
            // –ú–µ—Ä—Ü–∞–µ—Ç, –Ω–æ —Ä–µ–∂–µ –ø—Ä–æ–ø–∞–¥–∞–µ—Ç (–≤–∏–¥–µ–Ω 80% –≤—Ä–µ–º–µ–Ω–∏)
            buffSystem.buffIcon.visible = (Math.floor(buffSystem.buffIcon.timeLeft / 15) % 4 !== 0);
        }
        
        // –ï—Å–ª–∏ –≤—Ä–µ–º—è –≤—ã—à–ª–æ - —Å–∫—Ä—ã—Ç—å –±–∞—Ñ
        if (buffSystem.buffIcon.timeLeft <= 0) {
            buffSystem.buffIcon.visible = false;
        }
    }
    
              // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏—è —Å —Ä–∞–∫–µ—Ç–∫–æ–π –ò–õ–ò –º—è—á–æ–º
            if (buffSystem.buffIcon.visible) {
                const icon = buffSystem.buffIcon;
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å —Ä–∞–∫–µ—Ç–∫–æ–π –∏–≥—Ä–æ–∫–∞
                if (icon.x > player.x - 20 && icon.x < player.x + player.width + 20 &&
                    icon.y > player.y - 20 && icon.y < player.y + player.height + 20) {
                    
                    activateBuff(icon.type);
                    buffSystem.buffIcon.visible = false;
                    if (game.sound) beep(1200, 0.3);
                }
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å –º—è—á–æ–º (–¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞)
                const dx = ball.x - icon.x;
                const dy = ball.y - icon.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                if (distance < ball.size + 25) { // –ï—Å–ª–∏ –º—è—á –±–ª–∏–∑–∫–æ –∫ –±–∞—Ñ—É
                    activateBuff(icon.type);
                    buffSystem.buffIcon.visible = false;
                    if (game.sound) beep(1200, 0.3);
                }
            }
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –±–∞—Ñ–∞
    if (buffSystem.activeBuff) {
        buffSystem.activeUntil--;
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞
        const secondsLeft = Math.ceil(buffSystem.activeUntil / 60);
        document.getElementById('activeBuffInfo').textContent = 
            `${buffSystem.activeBuff.icon} ${buffSystem.activeBuff.name}: ${secondsLeft}—Å`;
        
        if (buffSystem.activeUntil <= 0) {
            deactivateBuff();
        }
    }
}

function spawnBuffIcon() {
    if (buffSystem.activeBuff || buffSystem.buffIcon.visible) return;
    
    const buffTypes = Object.values(BUFFS);
    const randomBuff = buffTypes[Math.floor(Math.random() * buffTypes.length)];
    
    // –°–ª—É—á–∞–π–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è –Ω–∞ –ø–æ–ª–µ (–Ω–æ –Ω–µ —Å–ª–∏—à–∫–æ–º –±–ª–∏–∑–∫–æ –∫ –∫—Ä–∞—è–º)
    const x = 50 + Math.random() * (canvas.width - 100);
    const y = 50 + Math.random() * (canvas.height - 100);
    
    buffSystem.buffIcon = {
        x: x,
        y: y,
        type: randomBuff,
        visible: true,
        speed: 2,
        timeLeft: 180 // 3 —Å–µ–∫—É–Ω–¥—ã –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è (60 FPS * 3)
    };
}
        function activateBuff(buff) {
            buffSystem.activeBuff = buff;
            buffSystem.activeUntil = buff.duration;
            
            // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —ç—Ñ—Ñ–µ–∫—Ç–æ–≤
            if (buff.effect === 'size') {
                ball.size = buffSystem.originalBallSize * buff.multiplier;
            } else if (buff.effect === 'speed') {
                ball.dx *= buff.multiplier;
                ball.dy *= buff.multiplier;
            } else if (buff.effect === 'color') {
                buffSystem.hitsWithColor = 0;
            }
            
            // –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
            document.getElementById('activeBuffInfo').style.display = 'block';
        }
        
        function deactivateBuff() {
            if (!buffSystem.activeBuff) return;
            
            // –û—Ç–º–µ–Ω–∞ —ç—Ñ—Ñ–µ–∫—Ç–æ–≤
            const buff = buffSystem.activeBuff;
            
            if (buff.effect === 'size') {
                ball.size = buffSystem.originalBallSize;
            } else if (buff.effect === 'speed') {
                ball.dx /= buff.multiplier;
                ball.dy /= buff.multiplier;
            } else if (buff.effect === 'color') {
                // –í–æ–∑–≤—Ä–∞—Ç –æ–±—ã—á–Ω–æ–≥–æ —Ü–≤–µ—Ç–∞
                ctx.fillStyle = ball.originalColor;
            }
            
            buffSystem.activeBuff = null;
            document.getElementById('activeBuffInfo').style.display = 'none';
        }
        
        function drawBuffs() {
            // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∏–∫–æ–Ω–∫–∏ –±–∞—Ñ–∞
            if (buffSystem.buffIcon.visible) {
                const icon = buffSystem.buffIcon;
                
                // –°–≤–µ—á–µ–Ω–∏–µ
                ctx.shadowColor = icon.type.color;
                ctx.shadowBlur = 15;
                
                // –ö—Ä—É–≥ –∏–∫–æ–Ω–∫–∏
                ctx.fillStyle = icon.type.color;
                ctx.beginPath();
                ctx.arc(icon.x, icon.y, 20, 0, Math.PI * 2);
                ctx.fill();
                
                // –ò–∫–æ–Ω–∫–∞
                ctx.fillStyle = '#FFFFFF';
                ctx.font = 'bold 24px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(icon.type.icon, icon.x, icon.y);
                
                // –°–±—Ä–æ—Å —Ç–µ–Ω–∏
                ctx.shadowBlur = 0;
            }
            
            // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —ç—Ñ—Ñ–µ–∫—Ç–æ–≤ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –±–∞—Ñ–∞
            if (buffSystem.activeBuff) {
                const buff = buffSystem.activeBuff;
                
                // –≠—Ñ—Ñ–µ–∫—Ç –¥–ª—è —Ü–≤–µ—Ç–Ω–æ–≥–æ –º—è—á–∞
                if (buff.effect === 'color') {
                    const colorIndex = buffSystem.hitsWithColor % buff.colors.length;
                    ctx.fillStyle = buff.colors[colorIndex];
                }
            }
        }
        
        // ========== –ò–ì–†–û–í–ê–Ø –õ–û–ì–ò–ö–ê ==========
        function update() {
            if (!game.active || game.paused) return;
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞—Ñ–æ–≤
            updateBuffs();
            
            // –ò–≥—Ä–æ–∫
            if ((keys['w'] || keys['arrowup']) && player.y > 0) {
                player.y -= player.speed;
            }
            if ((keys['s'] || keys['arrowdown']) && player.y < canvas.height - player.height) {
                player.y += player.speed;
            }
            
            // AI
            const diff = DIFFICULTY[game.difficulty];
            let targetY = ball.y - opponent.height / 2;
            
            if (Math.random() > diff.aiAccuracy) {
                targetY += (Math.random() - 0.5) * 70;
            }
            
            if (opponent.y < targetY && opponent.y < canvas.height - opponent.height) {
                opponent.y += Math.min(opponent.speed, targetY - opponent.y);
            }
            if (opponent.y > targetY && opponent.y > 0) {
                opponent.y -= Math.min(opponent.speed, opponent.y - targetY);
            }
            
            // –ú—è—á
            ball.x += ball.dx;
            ball.y += ball.dy;
            
            // –û—Ç—Å–∫–æ–∫ –æ—Ç —Å—Ç–µ–Ω
            if (ball.y <= ball.size || ball.y >= canvas.height - ball.size) {
                ball.dy *= -1;
                beep(600, 0.1);
            }
            
            // –°—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏—è
            const hitPlayer = ball.x - ball.size < player.x + player.width &&
                            ball.x + ball.size > player.x &&
                            ball.y > player.y && 
                            ball.y < player.y + player.height;
            
            const hitOpponent = ball.x + ball.size > opponent.x &&
                              ball.x - ball.size < opponent.x + opponent.width &&
                              ball.y > opponent.y && 
                              ball.y < opponent.y + opponent.height;
            
            if (hitPlayer) {
                ball.dx = Math.abs(ball.dx);
                ball.dy = 5 * ((ball.y - player.y) / player.height - 0.5);
                ball.x = player.x + player.width + ball.size;
                beep(800, 0.05);
                
                // –ü–æ–¥—Å—á–µ—Ç —É–¥–∞—Ä–æ–≤ –¥–ª—è —Ü–≤–µ—Ç–Ω–æ–≥–æ –±–∞—Ñ–∞
                if (buffSystem.activeBuff && buffSystem.activeBuff.effect === 'color') {
                    buffSystem.hitsWithColor++;
                }
            }
            
            if (hitOpponent) {
                ball.dx = -Math.abs(ball.dx);
                ball.dy = 5 * ((ball.y - opponent.y) / opponent.height - 0.5);
                ball.x = opponent.x - ball.size;
                beep(800, 0.05);
                
                // –ü–æ–¥—Å—á–µ—Ç —É–¥–∞—Ä–æ–≤ –¥–ª—è —Ü–≤–µ—Ç–Ω–æ–≥–æ –±–∞—Ñ–∞
                if (buffSystem.activeBuff && buffSystem.activeBuff.effect === 'color') {
                    buffSystem.hitsWithColor++;
                }
            }
            
            // –ì–æ–ª—ã
            if (ball.x - ball.size <= 0) {
                game.opponentScore++;
                
                // –ë–æ–Ω—É—Å–Ω—ã–µ –æ—á–∫–∏ –¥–ª—è —Ü–≤–µ—Ç–Ω–æ–≥–æ –±–∞—Ñ–∞
                if (buffSystem.activeBuff && buffSystem.activeBuff.effect === 'color' && 
                    buffSystem.activeBuff.bonusPoints) {
                    game.opponentScore += buffSystem.activeBuff.bonusPoints;
                }
                
                resetBall();
                beep(300, 0.2);
            }
            
            if (ball.x + ball.size >= canvas.width) {
                game.playerScore++;
                
                // –ë–æ–Ω—É—Å–Ω—ã–µ –æ—á–∫–∏ –¥–ª—è —Ü–≤–µ—Ç–Ω–æ–≥–æ –±–∞—Ñ–∞
                if (buffSystem.activeBuff && buffSystem.activeBuff.effect === 'color' && 
                    buffSystem.activeBuff.bonusPoints) {
                    game.playerScore += buffSystem.activeBuff.bonusPoints;
                }
                
                resetBall();
                beep(1000, 0.2);
            }
            
            updateScore();
            
            // –ö–æ–Ω–µ—Ü –∏–≥—Ä—ã
            if (game.playerScore >= 10 || game.opponentScore >= 10) {
                endGame();
            }
        }
        
        function resetBall() {
            ball.x = canvas.width / 2;
            ball.y = canvas.height / 2;
            ball.dx = game.ballSpeed * (Math.random() > 0.5 ? 1 : -1);
            ball.dy = game.ballSpeed * (Math.random() > 0.5 ? 1 : -1);
            
            // –ü—Ä–∏–º–µ–Ω—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏
            const config = DIFFICULTY[game.difficulty];
            ball.dx = Math.sign(ball.dx) * config.ballSpeed;
            ball.dy = Math.sign(ball.dy) * config.ballSpeed;
            
            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Ü–≤–µ—Ç
            ctx.fillStyle = ball.originalColor;
        }
        
        function updateScore() {
            document.getElementById('scoreDisplay').textContent = 
                `${game.playerScore} : ${game.opponentScore}`;
        }
        
        // ========== –ö–û–ù–ï–¶ –ò–ì–†–´ ==========
        function endGame() {
            game.active = false;
            
            // –î–µ–∞–∫—Ç–∏–≤–∞—Ü–∏—è –±–∞—Ñ–æ–≤
            deactivateBuff();
            document.getElementById('buffsIndicator').style.display = 'none';
            
            const playerWon = game.playerScore >= 10;
            const phrases = playerWon ? PHRASES.win : PHRASES.lose;
            const phrase = phrases[Math.floor(Math.random() * phrases.length)];
            
            document.getElementById('gameOverTitle').textContent = 
                playerWon ? "üéâ –ü–û–ë–ï–î–ê!" : "üéÆ –ò–ì–†–ê –û–ö–û–ù–ß–ï–ù–ê";
            document.getElementById('gameMessage').textContent = phrase;
            document.getElementById('finalScore').textContent = 
                `${game.playerScore} : ${game.opponentScore}`;
            
            setTimeout(() => showScreen('gameOverScreen'), 500);
        }
        
        function restartGame() {
            showScreen('gameScreen');
            initGame();
        }
        
        // ========== –ü–ê–£–ó–ê ==========
        function pauseGame() {
            if (!game.active) return;
            
            game.paused = !game.paused;
            document.getElementById('pauseBtn').textContent = 
                game.paused ? '‚ñ∂ –ü–†–û–î–û–õ–ñ–ò–¢–¨' : '‚è∏ –ü–ê–£–ó–ê';
            
            if (game.sound) beep(400, 0.1);
        }
        
        // ========== –û–¢–†–ò–°–û–í–ö–ê ==========
        function draw() {
            // –§–æ–Ω
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // –õ–∏–Ω–∏—è
            ctx.setLineDash([5, 8]);
            ctx.beginPath();
            ctx.moveTo(canvas.width / 2, 0);
            ctx.lineTo(canvas.width / 2, canvas.height);
            ctx.strokeStyle = '#333';
            ctx.stroke();
            ctx.setLineDash([]);
            
            // –†–∞–∫–µ—Ç–∫–∏
            ctx.fillStyle = '#4CAF50';
            ctx.fillRect(player.x, player.y, player.width, player.height);
            
            ctx.fillStyle = '#f44336';
            ctx.fillRect(opponent.x, opponent.y, opponent.width, opponent.height);
            
            // –ú—è—á (—Ü–≤–µ—Ç –º–æ–∂–µ—Ç –º–µ–Ω—è—Ç—å—Å—è –∏–∑-–∑–∞ –±–∞—Ñ–æ–≤)
            if (!buffSystem.activeBuff || buffSystem.activeBuff.effect !== 'color') {
                ctx.fillStyle = ball.originalColor
       ctx.fillStyle = ball.originalColor;
            }
            
            // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –º—è—á–∞
            ctx.beginPath();
            ctx.arc(ball.x, ball.y, ball.size, 0, Math.PI * 2);
            ctx.fill();
            
            // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –±–∞—Ñ–æ–≤ (–∏–∫–æ–Ω–∫–∏ –∏ —ç—Ñ—Ñ–µ–∫—Ç—ã)
            drawBuffs();
            
            // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –ø–∞—É–∑—ã
            if (game.paused) {
                ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                ctx.fillStyle = '#FF9800';
                ctx.font = 'bold 36px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText('–ü–ê–£–ó–ê', canvas.width / 2, canvas.height / 2 - 40);
                
                ctx.fillStyle = '#FFF';
                ctx.font = '18px Arial';
                ctx.fillText('–ù–∞–∂–º–∏—Ç–µ –ü–†–û–ë–ï–õ –∏–ª–∏ –∫–Ω–æ–ø–∫—É –ü–ê–£–ó–´', canvas.width / 2, canvas.height / 2 + 20);
                ctx.fillText('–¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è', canvas.width / 2, canvas.height / 2 + 50);
            }
        }

        // ========== –ó–í–£–ö–ò ==========
        function beep(frequency, duration) {
            if (!game.sound) return;
            
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = frequency;
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + duration);
            } catch (e) {
                // –ê—É–¥–∏–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ
            }
        }

        // ========== –ò–ì–†–û–í–û–ô –¶–ò–ö–õ ==========
        function gameLoop() {
            update();
            draw();
            
            if (game.active) {
                requestAnimationFrame(gameLoop);
            }
        }

        // ========== –ó–ê–ì–†–£–ó–ö–ê –ù–ê–°–¢–†–û–ï–ö ==========
        function loadSettings() {
            try {
                const saved = JSON.parse(localStorage.getItem('pingpongSettings'));
                if (saved) {
                    game.sound = saved.sound !== undefined ? saved.sound : true;
                    game.showMobile = saved.showMobile !== undefined ? saved.showMobile : true;
                    game.buffsEnabled = saved.buffsEnabled !== undefined ? saved.buffsEnabled : true;
                    game.ballSpeed = saved.ballSpeed !== undefined ? saved.ballSpeed : 5;
                    
                    document.getElementById('soundToggle').checked = game.sound;
                    document.getElementById('mobileButtons').checked = game.showMobile;
                    document.getElementById('buffsToggle').checked = game.buffsEnabled;
                    document.getElementById('ballSpeed').value = game.ballSpeed;
                    document.getElementById('speedValue').textContent = game.ballSpeed;
                }
            } catch (e) {
                // –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫
            }
        }

        // ========== –û–ë–†–ê–ë–û–¢–ö–ê –†–ï–°–ê–ô–ó–ê ==========
        window.addEventListener('resize', () => {
            if (canvas && game.active) {
                const container = canvas.parentElement;
                const maxWidth = Math.min(500, container.clientWidth - 20);
                canvas.width = maxWidth;
                canvas.height = Math.min(400, window.innerHeight * 0.5);
                
                // –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ–∑–∏—Ü–∏–π –æ–±—ä–µ–∫—Ç–æ–≤ –ø—Ä–∏ —Ä–µ—Å–∞–π–∑–µ
                player.y = Math.min(player.y, canvas.height - player.height);
                opponent.y = Math.min(opponent.y, canvas.height - opponent.height);
                
                if (ball.y > canvas.height - ball.size) {
                    ball.y = canvas.height - ball.size;
                }
            }
        });

        // ========== –ü–†–ï–î–û–¢–í–†–ê–©–ï–ù–ò–ï –°–ö–†–û–õ–õ–ê –ü–†–ò –ö–ê–°–ê–ù–ò–ò ==========
        document.addEventListener('touchmove', (e) => {
            if (e.target.closest('.mobile-btn') || e.target.closest('#gameCanvas')) {
                e.preventDefault();
            }
        }, { passive: false });

        // ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ü–†–ò –ó–ê–ì–†–£–ó–ö–ï ==========
        window.addEventListener('DOMContentLoaded', () => {
            loadSettings();
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            if (isMobile) {
                document.getElementById('mobileControls').classList.remove('hidden');
            }
            
            // –ü–æ–∫–∞–∑–∞—Ç—å –º–µ–Ω—é
            showScreen('menuScreen');
            
            // –§–æ–∫—É—Å –Ω–∞ –∏–≥—Ä–µ –¥–ª—è —Ä–∞–±–æ—Ç—ã –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
            document.addEventListener('click', () => {
                if (game.active) {
                    canvas.focus();
                }
            });
            
            console.log('Ping Pong Pro v1.2 –∑–∞–≥—Ä—É–∂–µ–Ω! üéÆ');
        });

        // ========== –ì–õ–û–ë–ê–õ–¨–ù–´–ô –î–û–°–¢–£–ü –î–õ–Ø –û–¢–õ–ê–î–ö–ò ==========
        window.game = game;
        window.buffSystem = buffSystem;
        window.BUFFS = BUFFS;
    </script>
</body>
</html>
